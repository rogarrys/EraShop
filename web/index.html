<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EraShop</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
<style>
:root {
    --bg-base: #080811;
    --bg-surface: #0f0f1a;
    --bg-elevated: #161625;
    --bg-card: rgba(255,255,255,0.025);
    --bg-card-hover: rgba(255,255,255,0.05);
    --bg-glass: rgba(16,16,32,0.92);
    --bg-input: rgba(255,255,255,0.04);
    --border: rgba(255,255,255,0.06);
    --border-hover: rgba(139,92,246,0.4);
    --border-active: rgba(139,92,246,0.6);
    --primary: #8b5cf6;
    --primary-soft: #a78bfa;
    --primary-dim: rgba(139,92,246,0.12);
    --primary-glow: rgba(139,92,246,0.2);
    --accent: #06b6d4;
    --accent-soft: #22d3ee;
    --green: #10b981;
    --green-soft: #34d399;
    --green-dim: rgba(16,185,129,0.12);
    --red: #ef4444;
    --red-dim: rgba(239,68,68,0.1);
    --orange: #f59e0b;
    --text: #e8edf5;
    --text2: #8b95a8;
    --text3: #555e70;
    --r-sm: 8px;
    --r-md: 12px;
    --r-lg: 16px;
    --r-xl: 24px;
}
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Inter',system-ui,sans-serif;background:var(--bg-base);color:var(--text);overflow:hidden;height:100vh;-webkit-font-smoothing:antialiased}
::-webkit-scrollbar{width:5px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:rgba(139,92,246,0.25);border-radius:3px}

body::before{content:'';position:fixed;inset:0;background:radial-gradient(ellipse 80% 60% at 50% -20%,rgba(139,92,246,0.08),transparent),radial-gradient(ellipse 60% 40% at 80% 100%,rgba(6,182,212,0.05),transparent);pointer-events:none;z-index:0}

#loader{position:fixed;inset:0;z-index:9999;display:flex;align-items:center;justify-content:center;flex-direction:column;background:var(--bg-base);transition:opacity .5s}
#loader.out{opacity:0;pointer-events:none}
.spinner{width:40px;height:40px;border:3px solid var(--border);border-top-color:var(--primary);border-radius:50%;animation:spin .7s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.load-text{margin-top:14px;color:var(--text3);font-size:13px;font-weight:500}

#app{display:none;flex-direction:column;height:100vh;position:relative;z-index:1}
#app.on{display:flex;animation:appIn .35s ease}
@keyframes appIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}

.topbar{display:flex;align-items:center;gap:16px;padding:16px 28px;border-bottom:1px solid var(--border);background:var(--bg-glass);backdrop-filter:blur(20px);flex-shrink:0}
.topbar-brand{display:flex;align-items:center;gap:12px;flex:1;min-width:0}
.brand-icon{width:40px;height:40px;border-radius:var(--r-md);background:linear-gradient(135deg,var(--primary),var(--accent));display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0}
.brand-name{font-size:17px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.brand-id{font-size:11px;color:var(--text3);font-weight:500}
.topbar-wallet{display:flex;align-items:center;gap:6px;padding:7px 14px;background:var(--green-dim);border:1px solid rgba(16,185,129,0.15);border-radius:var(--r-sm);font-size:13px;font-weight:600;color:var(--green-soft)}
.topbar-actions{display:flex;align-items:center;gap:8px}
.tb-btn{height:36px;padding:0 14px;border-radius:var(--r-sm);border:1px solid var(--border);background:var(--bg-input);color:var(--text2);font-size:12px;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:6px;transition:all .2s;font-family:inherit}
.tb-btn:hover{border-color:var(--border-hover);color:var(--text);background:var(--primary-dim)}
.tb-btn.accent{background:linear-gradient(135deg,#7c3aed,var(--primary));color:#fff;border:none}
.tb-btn.accent:hover{filter:brightness(1.12)}
.tb-btn.close-btn{color:var(--text3)}
.tb-btn.close-btn:hover{background:var(--red-dim);color:var(--red);border-color:rgba(239,68,68,0.2)}

.nav-bar{display:flex;align-items:center;gap:12px;padding:12px 28px;border-bottom:1px solid var(--border);flex-shrink:0;background:rgba(15,15,26,0.5)}
.search-wrap{position:relative;width:220px;flex-shrink:0}
.search-wrap input{width:100%;padding:8px 12px 8px 34px;background:var(--bg-input);border:1px solid var(--border);border-radius:var(--r-sm);color:var(--text);font-size:13px;font-family:inherit;outline:none;transition:all .2s}
.search-wrap input:focus{border-color:var(--primary);box-shadow:0 0 0 3px var(--primary-glow)}
.search-wrap input::placeholder{color:var(--text3)}
.search-wrap::before{content:'ğŸ”';position:absolute;left:10px;top:50%;transform:translateY(-50%);font-size:13px;pointer-events:none}
.cat-scroll{display:flex;gap:6px;flex:1;overflow-x:auto;padding:2px 0}
.cat-scroll::-webkit-scrollbar{height:0}
.cat-pill{padding:7px 16px;border-radius:20px;font-size:12px;font-weight:600;cursor:pointer;white-space:nowrap;transition:all .2s;border:1px solid var(--border);background:var(--bg-card);color:var(--text2);display:flex;align-items:center;gap:6px;user-select:none;flex-shrink:0}
.cat-pill:hover{border-color:var(--border-hover);color:var(--text);background:var(--primary-dim)}
.cat-pill.on{background:linear-gradient(135deg,rgba(139,92,246,0.2),rgba(6,182,212,0.1));border-color:var(--border-active);color:var(--primary-soft);box-shadow:0 0 16px var(--primary-glow)}
.cat-pill .cnt{font-size:10px;background:rgba(255,255,255,0.08);padding:1px 7px;border-radius:10px;color:var(--text3)}
.cat-pill.on .cnt{background:rgba(139,92,246,0.2);color:var(--primary-soft)}
.cat-pill.locked{opacity:.4;cursor:default}

.content{flex:1;overflow-y:auto;padding:24px 28px}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:14px}
.card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--r-lg);padding:18px;cursor:pointer;transition:all .22s;position:relative;overflow:hidden}
.card::after{content:'';position:absolute;inset:0;background:linear-gradient(135deg,rgba(139,92,246,0.04),transparent);opacity:0;transition:opacity .22s}
.card:hover{border-color:var(--border-hover);transform:translateY(-2px);box-shadow:0 12px 40px rgba(0,0,0,0.3),0 0 20px var(--primary-glow)}
.card:hover::after{opacity:1}
.card.locked{opacity:.35;pointer-events:none}
.card-emoji{font-size:32px;margin-bottom:12px;display:block}
.card-name{font-size:14px;font-weight:600;margin-bottom:3px;line-height:1.3}
.card-desc{font-size:11px;color:var(--text3);line-height:1.5;margin-bottom:14px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;min-height:33px}
.card-bottom{display:flex;align-items:center;justify-content:space-between}
.card-price{font-size:15px;font-weight:700;color:var(--green-soft)}
.card-buy{padding:5px 14px;border-radius:6px;background:var(--primary);color:#fff;font-size:11px;font-weight:700;border:none;cursor:pointer;transition:all .15s;font-family:inherit;position:relative;z-index:2}
.card-buy:hover{filter:brightness(1.15);transform:scale(1.05)}

.empty{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;color:var(--text3);text-align:center;padding:40px}
.empty-ico{font-size:56px;margin-bottom:14px;opacity:.25}
.empty-t{font-size:16px;font-weight:600;color:var(--text2);margin-bottom:6px}
.empty-d{font-size:12px;max-width:280px;line-height:1.7}

.overlay{position:fixed;inset:0;z-index:1000;background:rgba(0,0,0,.55);backdrop-filter:blur(6px);display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .25s}
.overlay.on{opacity:1;pointer-events:all}
.modal{background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--r-xl);padding:32px;max-width:400px;width:90%;box-shadow:0 24px 80px rgba(0,0,0,.5);transform:scale(.95);transition:transform .25s}
.overlay.on .modal{transform:scale(1)}
.m-emoji{font-size:48px;text-align:center;margin-bottom:16px;display:block}
.m-title{font-size:18px;font-weight:700;text-align:center;margin-bottom:6px}
.m-desc{font-size:12px;color:var(--text3);text-align:center;line-height:1.6;margin-bottom:4px}
.m-price{font-size:26px;font-weight:800;text-align:center;margin:14px 0;color:var(--green-soft)}
.m-btns{display:flex;gap:10px;margin-top:18px}
.m-btns button{flex:1;padding:11px;border-radius:var(--r-sm);font-size:13px;font-weight:600;cursor:pointer;border:none;transition:all .2s;font-family:inherit}
.m-cancel{background:var(--bg-input);color:var(--text2);border:1px solid var(--border) !important}
.m-cancel:hover{background:var(--bg-card-hover)}
.m-confirm{background:linear-gradient(135deg,var(--green),#059669);color:#fff}
.m-confirm:hover{filter:brightness(1.1)}
.m-confirm.disabled{background:var(--red);cursor:not-allowed}

.adm-overlay{position:fixed;inset:0;z-index:2000;background:rgba(0,0,0,.65);backdrop-filter:blur(10px);display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .3s}
.adm-overlay.on{opacity:1;pointer-events:all}
.adm{background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--r-xl);width:92%;max-width:920px;max-height:88vh;display:flex;flex-direction:column;box-shadow:0 24px 80px rgba(0,0,0,.5);transform:scale(.95) translateY(8px);transition:transform .3s}
.adm-overlay.on .adm{transform:none}
.adm-head{padding:18px 22px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.adm-head-left{display:flex;align-items:center;gap:10px}
.adm-badge{padding:3px 10px;border-radius:6px;background:linear-gradient(135deg,#7c3aed,var(--primary));font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.5px}
.adm-title{font-size:16px;font-weight:700}
.adm-x{width:34px;height:34px;border-radius:var(--r-sm);background:var(--bg-input);border:1px solid var(--border);color:var(--text3);font-size:16px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .2s}
.adm-x:hover{background:var(--red-dim);color:var(--red);border-color:rgba(239,68,68,.25)}
.adm-tabs{display:flex;gap:4px;padding:10px 22px;border-bottom:1px solid var(--border)}
.adm-tab{padding:7px 16px;border-radius:var(--r-sm);font-size:12px;font-weight:600;cursor:pointer;color:var(--text3);background:none;border:none;transition:all .2s;font-family:inherit}
.adm-tab:hover{color:var(--text);background:var(--bg-input)}
.adm-tab.on{color:var(--primary-soft);background:var(--primary-dim)}
.adm-body{flex:1;overflow-y:auto;padding:22px}

.fg{margin-bottom:16px}
.fl{display:block;font-size:11px;font-weight:600;color:var(--text2);margin-bottom:5px;text-transform:uppercase;letter-spacing:.5px}
.fi,.fs,.ft{width:100%;padding:9px 13px;background:var(--bg-input);border:1px solid var(--border);border-radius:var(--r-sm);color:var(--text);font-size:13px;font-family:inherit;outline:none;transition:all .2s}
.fi:focus,.fs:focus,.ft:focus{border-color:var(--primary);box-shadow:0 0 0 3px var(--primary-glow)}
.ft{resize:vertical;min-height:52px}
.fs{cursor:pointer}
.fs option{background:var(--bg-surface);color:var(--text)}
.fr{display:flex;gap:10px}
.fr .fg{flex:1}

.sc-grid{display:flex;flex-wrap:wrap;gap:6px;margin-top:5px}
.sc{padding:5px 13px;border-radius:18px;background:var(--bg-input);border:1px solid var(--border);font-size:11px;font-weight:500;cursor:pointer;color:var(--text2);transition:all .2s;user-select:none}
.sc:hover{border-color:var(--primary);color:var(--text)}
.sc.on{background:var(--primary-dim);border-color:var(--primary);color:var(--primary-soft)}

.al{display:flex;flex-direction:column;gap:7px}
.ali{display:flex;align-items:center;gap:11px;padding:12px 14px;border-radius:var(--r-md);background:var(--bg-card);border:1px solid var(--border);transition:all .2s}
.ali:hover{border-color:var(--border-hover)}
.ali-ico{font-size:18px;min-width:26px;text-align:center}
.ali-info{flex:1;min-width:0}
.ali-name{font-size:13px;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.ali-meta{font-size:10px;color:var(--text3);margin-top:2px}
.ali-acts{display:flex;gap:5px}
.ali-btn{width:30px;height:30px;border-radius:var(--r-sm);display:flex;align-items:center;justify-content:center;font-size:13px;cursor:pointer;border:1px solid var(--border);background:var(--bg-input);color:var(--text3);transition:all .2s}
.ali-btn:hover{border-color:var(--primary);color:var(--primary)}
.ali-btn.del:hover{border-color:var(--red);color:var(--red)}

.add-row{display:flex;align-items:center;justify-content:center;gap:7px;padding:11px;border-radius:var(--r-md);background:none;border:2px dashed var(--border);color:var(--text3);font-size:12px;font-weight:600;cursor:pointer;transition:all .2s;font-family:inherit;width:100%;margin-top:10px}
.add-row:hover{border-color:var(--primary);color:var(--primary-soft);background:rgba(139,92,246,.03)}

.iform{padding:16px;border-radius:var(--r-md);background:rgba(139,92,246,.04);border:1px solid rgba(139,92,246,.12);margin-top:10px;animation:sld .2s ease}
@keyframes sld{from{opacity:0;transform:translateY(-6px)}to{opacity:1;transform:none}}
.iform-t{font-size:13px;font-weight:600;color:var(--primary-soft);margin-bottom:12px}
.iform-acts{display:flex;gap:7px;margin-top:12px}
.iform-acts button{padding:7px 16px;border-radius:var(--r-sm);font-size:12px;font-weight:600;cursor:pointer;border:none;transition:all .2s;font-family:inherit}
.btn-ok{background:var(--primary);color:#fff}
.btn-ok:hover{filter:brightness(1.12)}
.btn-no{background:var(--bg-input);color:var(--text2);border:1px solid var(--border) !important}

.dzone{margin-top:22px;padding:14px;border-radius:var(--r-md);border:1px solid rgba(239,68,68,.15);background:var(--red-dim)}
.dzone-t{font-size:13px;font-weight:600;color:var(--red);margin-bottom:6px}
.dzone-d{font-size:11px;color:var(--text3);margin-bottom:10px}
.dzone-btn{padding:9px 18px;border-radius:var(--r-sm);background:var(--red);color:#fff;font-size:12px;font-weight:600;cursor:pointer;border:none;transition:all .2s;font-family:inherit}
.dzone-btn:hover{filter:brightness(1.15)}

#toasts{position:fixed;bottom:18px;right:18px;z-index:5000;display:flex;flex-direction:column-reverse;gap:7px}
.toast{padding:10px 18px;border-radius:var(--r-md);background:var(--bg-glass);backdrop-filter:blur(14px);border:1px solid var(--border);font-size:12px;font-weight:500;box-shadow:0 8px 30px rgba(0,0,0,.4);animation:tIn .25s ease;max-width:340px}
.toast.ok{border-left:3px solid var(--green);color:var(--green-soft)}
.toast.err{border-left:3px solid var(--red);color:var(--red)}
.toast.bye{animation:tOut .25s ease forwards}
@keyframes tIn{from{opacity:0;transform:translateX(16px)}to{opacity:1;transform:none}}
@keyframes tOut{to{opacity:0;transform:translateX(16px)}}

.hidden{display:none !important}
</style>
</head>
<body>

<!-- Loading -->
<div id="loader"><div class="spinner"></div><div class="load-text">Chargement du shop...</div></div>

<!-- App -->
<div id="app">
    <!-- Top bar -->
    <div class="topbar">
        <div class="topbar-brand">
            <div class="brand-icon">ğŸ›’</div>
            <div>
                <div class="brand-name" id="hd-name">Shop</div>
                <div class="brand-id" id="hd-id"></div>
            </div>
        </div>
        <div class="topbar-wallet">ğŸ’° $<span id="hd-money">0</span></div>
        <div class="topbar-actions">
            <button class="tb-btn accent hidden" id="btn-adm" data-action="open-admin">âš™ï¸ Admin</button>
            <button class="tb-btn close-btn" data-action="close-menu">âœ• Fermer</button>
        </div>
    </div>

    <!-- Nav bar: search + category pills -->
    <div class="nav-bar">
        <div class="search-wrap">
            <input type="text" id="search" placeholder="Rechercher un article...">
        </div>
        <div class="cat-scroll" id="cat-bar"></div>
    </div>

    <!-- Content -->
    <div class="content" id="content">
        <div class="empty" id="empty-msg">
            <div class="empty-ico">ğŸ“¦</div>
            <div class="empty-t">Aucun article</div>
            <div class="empty-d">Ce shop ne contient pas encore d'articles. Un admin peut en ajouter via le bouton Admin.</div>
        </div>
        <div class="grid" id="grid"></div>
    </div>
</div>

<!-- Purchase modal -->
<div class="overlay" id="buy-overlay">
    <div class="modal" id="buy-modal">
        <span class="m-emoji" id="buy-emoji">ğŸ›’</span>
        <div class="m-title" id="buy-title">Confirmer</div>
        <div class="m-desc" id="buy-desc"></div>
        <div class="m-price" id="buy-price">$0</div>
        <div class="m-btns">
            <button class="m-cancel" data-action="buy-cancel">Annuler</button>
            <button class="m-confirm" id="buy-ok" data-action="buy-confirm">Acheter</button>
        </div>
    </div>
</div>

<!-- Admin overlay -->
<div class="adm-overlay" id="adm-overlay">
    <div class="adm">
        <div class="adm-head">
            <div class="adm-head-left"><span class="adm-badge">Admin</span><span class="adm-title">Configuration</span></div>
            <button class="adm-x" data-action="close-admin">âœ•</button>
        </div>
        <div class="adm-tabs" id="adm-tabs">
            <button class="adm-tab on" data-tab="general">ğŸª GÃ©nÃ©ral</button>
            <button class="adm-tab" data-tab="categories">ğŸ“ CatÃ©gories</button>
            <button class="adm-tab" data-tab="items">ğŸ“¦ Articles</button>
        </div>
        <div class="adm-body" id="adm-body"></div>
    </div>
</div>

<!-- Toasts -->
<div id="toasts"></div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STATE
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
var S = null;
var AS = null;
var selCat = null;
var admTab = 'general';
var buyItem = null;
var admCatId = null;
var q = '';

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LUA BRIDGE (safe wrapper)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function _lua(fn) {
    var args = Array.prototype.slice.call(arguments, 1);
    try {
        if (typeof lua !== 'undefined' && lua[fn]) {
            lua[fn].apply(lua, args);
        } else {
            console.log('lua.' + fn + '(' + args.join(', ') + ')');
        }
    } catch(e) { console.log('lua bridge error:', e); }
}

window.receiveShopState = function(d) {
    try { if(typeof d === 'string') d = JSON.parse(d); } catch(e) {}
    S = d;
    document.getElementById('loader').classList.add('out');
    document.getElementById('app').classList.add('on');
    render();
};
window.receiveAdminState = function(d) {
    try { if(typeof d === 'string') d = JSON.parse(d); } catch(e) {}
    AS = d;
    if(document.getElementById('adm-overlay').classList.contains('on')) renderAdm();
};
window.showToast = function(msg, err) { toast(msg, err); };

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOAST
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function toast(msg, err) {
    var c = document.getElementById('toasts');
    var t = document.createElement('div');
    t.className = 'toast ' + (err ? 'err' : 'ok');
    t.textContent = msg;
    c.appendChild(t);
    setTimeout(function() { t.classList.add('bye'); }, 3000);
    setTimeout(function() { t.remove(); }, 3300);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RENDER SHOP
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function render() {
    if(!S || !S.shop) return;
    document.getElementById('hd-name').textContent = S.shop.name || 'Shop';
    document.getElementById('hd-id').textContent = '#' + S.shop.id;
    document.getElementById('hd-money').textContent = fmt(S.player ? S.player.money || 0 : 0);
    var ab = document.getElementById('btn-adm');
    if(S.player && S.player.isAdmin) ab.classList.remove('hidden'); else ab.classList.add('hidden');
    renderCats();
    renderGrid();
}

function renderCats() {
    var bar = document.getElementById('cat-bar');
    var cats = S.shop.categories || [];
    var ps = S.player && S.player.company ? S.player.company.sector : null;
    var h = '<span class="cat-pill' + (selCat === null ? ' on' : '') + '" data-cat="all">ğŸª Tout</span>';
    for(var i = 0; i < cats.length; i++) {
        var c = cats[i];
        var lk = isLocked(c, ps);
        var n = (c.items || []).length;
        h += '<span class="cat-pill' + (selCat === c.id ? ' on' : '') + (lk ? ' locked' : '') + '" data-cat="' + c.id + '">'
           + (c.icon || 'ğŸ“¦') + ' ' + esc(c.name)
           + ' <span class="cnt">' + n + '</span>'
           + (lk ? ' ğŸ”’' : '') + '</span>';
    }
    bar.innerHTML = h;
}

function renderGrid() {
    var grid = document.getElementById('grid');
    var emp = document.getElementById('empty-msg');
    var cats = S.shop.categories || [];
    var ps = S.player && S.player.company ? S.player.company.sector : null;
    var items = [];
    for(var i = 0; i < cats.length; i++) {
        var c = cats[i];
        var lk = isLocked(c, ps);
        var ci = c.items || [];
        for(var j = 0; j < ci.length; j++) {
            var it = ci[j];
            items.push({id:it.id, name:it.name, description:it.description, price:it.price, entity_class:it.entity_class, model:it.model, sort_order:it.sort_order, catId:c.id, locked:lk});
        }
    }
    if(selCat !== null) items = items.filter(function(x){return x.catId === selCat;});
    if(q) {
        var ql = q.toLowerCase();
        items = items.filter(function(x){return x.name.toLowerCase().indexOf(ql)!==-1||(x.description||'').toLowerCase().indexOf(ql)!==-1||(x.entity_class||'').toLowerCase().indexOf(ql)!==-1;});
    }
    if(items.length === 0) { grid.innerHTML = ''; emp.classList.remove('hidden'); return; }
    emp.classList.add('hidden');
    var h = '';
    for(var i = 0; i < items.length; i++) {
        var it = items[i];
        h += '<div class="card' + (it.locked ? ' locked' : '') + '" data-buy-id="' + it.id + '">'
           + '<span class="card-emoji">' + emoji(it) + '</span>'
           + '<div class="card-name">' + esc(it.name) + '</div>'
           + '<div class="card-desc">' + esc(it.description || 'Aucune description') + '</div>'
           + '<div class="card-bottom">'
           + '<span class="card-price">$' + fmt(it.price) + '</span>'
           + (it.locked ? '' : '<button class="card-buy" data-buy-id="' + it.id + '">Acheter</button>')
           + '</div></div>';
    }
    grid.innerHTML = h;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PURCHASE MODAL
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function openBuy(id) {
    if(!S || !S.shop) return;
    var item = findItem(id);
    if(!item) return;
    buyItem = item;
    document.getElementById('buy-emoji').textContent = emoji(item);
    document.getElementById('buy-title').textContent = item.name;
    document.getElementById('buy-desc').textContent = item.description || '';
    document.getElementById('buy-price').textContent = '$' + fmt(item.price);
    var ok = document.getElementById('buy-ok');
    var money = S.player ? S.player.money || 0 : 0;
    if(money < item.price) { ok.className = 'm-confirm disabled'; ok.textContent = 'Fonds insuffisants'; }
    else { ok.className = 'm-confirm'; ok.textContent = 'Acheter'; }
    document.getElementById('buy-overlay').classList.add('on');
}
function closeBuy() { document.getElementById('buy-overlay').classList.remove('on'); buyItem = null; }
function doBuy() {
    if(!buyItem || !S || !S.shop) return;
    _lua('buyItem', S.shop.id, buyItem.id);
    closeBuy();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ADMIN PANEL
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function openAdm() {
    if(!S || !S.shop) return;
    AS = {shop:S.shop, config:S.config};
    document.getElementById('adm-overlay').classList.add('on');
    _lua('requestAdminConfig', S.shop.id);
    renderAdm();
}
function closeAdm() {
    document.getElementById('adm-overlay').classList.remove('on');
    if(S && S.shop) _lua('requestAdminConfig', S.shop.id);
}
function setAdmTab(t) {
    admTab = t;
    var tabs = document.querySelectorAll('.adm-tab');
    for(var i=0;i<tabs.length;i++){tabs[i].classList.toggle('on', tabs[i].getAttribute('data-tab')===t);}
    renderAdm();
}
function renderAdm() {
    var b = document.getElementById('adm-body');
    var shop = AS ? AS.shop : (S ? S.shop : null);
    if(!shop){b.innerHTML='<div class="empty"><div class="empty-ico">â³</div></div>';return;}
    if(admTab==='general') admGeneral(b,shop);
    else if(admTab==='categories') admCats(b,shop);
    else if(admTab==='items') admItems(b,shop);
}

function admGeneral(b, shop) {
    var models = (AS && AS.config ? AS.config.npcModels : null) || (S && S.config ? S.config.npcModels : null) || [];
    var opts = '';
    for(var i=0;i<models.length;i++){
        opts+='<option value="'+models[i]+'"'+(models[i]===shop.npc_model?' selected':'')+'>'+models[i].split('/').pop()+'</option>';
    }
    b.innerHTML = '<div class="fg"><label class="fl">Nom du Shop</label><input class="fi" id="a-name" value="'+escA(shop.name||'')+'" placeholder="Nom..."></div>'
        +'<div class="fg"><label class="fl">ModÃ¨le NPC</label><select class="fs" id="a-model">'+opts+'</select></div>'
        +'<div style="margin-top:16px"><button class="tb-btn accent" data-action="save-general">ğŸ’¾ Sauvegarder</button></div>'
        +'<div class="dzone"><div class="dzone-t">âš ï¸ Zone dangereuse</div><div class="dzone-d">Supprimer ce shop, le NPC, et tout son contenu.</div><button class="dzone-btn" data-action="delete-shop">ğŸ—‘ï¸ Supprimer</button></div>';
}

function admCats(b, shop) {
    var cats = shop.categories || [];
    var h = '<div class="al" id="a-cat-list">';
    for(var i=0;i<cats.length;i++){
        var c=cats[i];
        var sl=(c.allowed_sectors||[]).join(', ')||'Tous';
        h+='<div class="ali"><span class="ali-ico">'+(c.icon||'ğŸ“¦')+'</span>'
          +'<div class="ali-info"><div class="ali-name">'+esc(c.name)+'</div><div class="ali-meta">Ordre: '+c.sort_order+' Â· Secteurs: '+esc(sl)+' Â· '+(c.items||[]).length+' articles</div></div>'
          +'<div class="ali-acts"><button class="ali-btn" data-action="edit-cat" data-id="'+c.id+'" title="Modifier">âœï¸</button><button class="ali-btn del" data-action="del-cat" data-id="'+c.id+'" title="Supprimer">ğŸ—‘ï¸</button></div></div>';
    }
    h+='</div><button class="add-row" data-action="add-cat-form">+ Ajouter une catÃ©gorie</button><div id="cat-form-zone"></div>';
    b.innerHTML=h;
}

function showCatForm(edit) {
    var sectors = (AS&&AS.config?AS.config.sectors:null)||(S&&S.config?S.config.sectors:null)||[];
    var zone = document.getElementById('cat-form-zone');
    var isE = !!edit;
    var selS = edit ? (edit.allowed_sectors||[]) : [];
    var chips = '';
    for(var i=0;i<sectors.length;i++){
        chips+='<span class="sc'+(selS.indexOf(sectors[i])!==-1?' on':'')+'" data-action="toggle-sc">'+esc(sectors[i])+'</span>';
    }
    zone.innerHTML='<div class="iform"><div class="iform-t">'+(isE?'âœï¸ Modifier':'â• Nouvelle')+' catÃ©gorie</div>'
        +'<div class="fr"><div class="fg"><label class="fl">Nom</label><input class="fi" id="cf-name" value="'+escA(edit?edit.name:'')+'" placeholder="Nom..."></div>'
        +'<div class="fg" style="max-width:90px"><label class="fl">IcÃ´ne</label><input class="fi" id="cf-icon" value="'+escA(edit?edit.icon:'ğŸ“¦')+'"></div>'
        +'<div class="fg" style="max-width:90px"><label class="fl">Ordre</label><input class="fi" id="cf-order" type="number" value="'+(edit?edit.sort_order:0)+'"></div></div>'
        +'<div class="fg"><label class="fl">Secteurs autorisÃ©s (vide = tous)</label><div class="sc-grid" id="cf-sectors">'+chips+'</div></div>'
        +'<div class="iform-acts"><button class="btn-ok" data-action="save-cat" data-edit="'+(isE?edit.id:'')+'">'+( isE?'Modifier':'CrÃ©er')+'</button><button class="btn-no" data-action="cancel-cat-form">Annuler</button></div></div>';
}

function doSaveCat(editId) {
    var shop = AS ? AS.shop : (S ? S.shop : null);
    if(!shop) return;
    var name = document.getElementById('cf-name').value.trim();
    var icon = document.getElementById('cf-icon').value.trim()||'ğŸ“¦';
    var order = parseInt(document.getElementById('cf-order').value)||0;
    var chips = document.querySelectorAll('#cf-sectors .sc.on');
    var sArr = [];
    for(var i=0;i<chips.length;i++) sArr.push(chips[i].textContent.trim());
    var sJson = JSON.stringify(sArr);
    if(!name){toast('Nom requis.',true);return;}
    if(editId) _lua('updateCategory',shop.id,editId,name,icon,order,sJson);
    else _lua('createCategory',shop.id,name,icon,order,sJson);
}

function admItems(b, shop) {
    var cats = shop.categories||[];
    if(cats.length===0){b.innerHTML='<div class="empty"><div class="empty-ico">ğŸ“</div><div class="empty-t">Aucune catÃ©gorie</div><div class="empty-d">CrÃ©ez une catÃ©gorie d\'abord dans l\'onglet CatÃ©gories.</div></div>';return;}
    if(!admCatId||!cats.filter(function(c){return c.id===admCatId;}).length) admCatId=cats[0].id;
    var opts='';
    for(var i=0;i<cats.length;i++){opts+='<option value="'+cats[i].id+'"'+(cats[i].id===admCatId?' selected':'')+'>'+esc((cats[i].icon||'')+' '+cats[i].name)+'</option>';}
    var h='<div class="fg"><label class="fl">CatÃ©gorie</label><select class="fs" id="a-item-cat">'+opts+'</select></div>';
    var cat=cats.filter(function(c){return c.id===admCatId;})[0];
    var items=cat?cat.items||[]:[];
    h+='<div class="al" id="a-item-list">';
    for(var i=0;i<items.length;i++){
        var it=items[i];
        h+='<div class="ali"><span class="ali-ico">'+emoji(it)+'</span>'
          +'<div class="ali-info"><div class="ali-name">'+esc(it.name)+'</div><div class="ali-meta">$'+fmt(it.price)+' Â· '+esc(it.entity_class||'N/A')+' Â· Ordre: '+it.sort_order+'</div></div>'
          +'<div class="ali-acts"><button class="ali-btn" data-action="edit-item" data-id="'+it.id+'" title="Modifier">âœï¸</button><button class="ali-btn del" data-action="del-item" data-id="'+it.id+'" title="Supprimer">ğŸ—‘ï¸</button></div></div>';
    }
    h+='</div><button class="add-row" data-action="add-item-form">+ Ajouter un article</button><div id="item-form-zone"></div>';
    b.innerHTML=h;
}

function showItemForm(edit) {
    var zone=document.getElementById('item-form-zone');
    var isE=!!edit;
    zone.innerHTML='<div class="iform"><div class="iform-t">'+(isE?'âœï¸ Modifier':'â• Nouvel')+' article</div>'
        +'<div class="fr"><div class="fg"><label class="fl">Nom</label><input class="fi" id="if-name" value="'+escA(edit?edit.name:'')+'" placeholder="Nom..."></div>'
        +'<div class="fg" style="max-width:130px"><label class="fl">Prix ($)</label><input class="fi" id="if-price" type="number" min="0" value="'+(edit?edit.price:0)+'"></div></div>'
        +'<div class="fg"><label class="fl">Description</label><textarea class="ft" id="if-desc" placeholder="Description...">'+esc(edit?edit.description:'')+'</textarea></div>'
        +'<div class="fr"><div class="fg"><label class="fl">Classe EntitÃ© / Arme</label><input class="fi" id="if-class" value="'+escA(edit?edit.entity_class:'')+'" placeholder="weapon_ak47, ..."></div>'
        +'<div class="fg"><label class="fl">ModÃ¨le (optionnel)</label><input class="fi" id="if-model" value="'+escA(edit?edit.model:'')+'" placeholder="models/..."></div></div>'
        +'<div class="fg" style="max-width:110px"><label class="fl">Ordre</label><input class="fi" id="if-order" type="number" value="'+(edit?edit.sort_order:0)+'"></div>'
        +'<div class="iform-acts"><button class="btn-ok" data-action="save-item" data-edit="'+(isE?edit.id:'')+'">'+( isE?'Modifier':'CrÃ©er')+'</button><button class="btn-no" data-action="cancel-item-form">Annuler</button></div></div>';
}

function doSaveItem(editId) {
    var shop = AS?AS.shop:(S?S.shop:null);
    if(!shop||!admCatId) return;
    var name=document.getElementById('if-name').value.trim();
    var desc=document.getElementById('if-desc').value.trim();
    var price=parseFloat(document.getElementById('if-price').value)||0;
    var cls=document.getElementById('if-class').value.trim();
    var mdl=document.getElementById('if-model').value.trim();
    var ord=parseInt(document.getElementById('if-order').value)||0;
    if(!name){toast('Nom requis.',true);return;}
    if(editId) _lua('updateItem',shop.id,editId,name,desc,price,cls,mdl,ord);
    else _lua('createItem',shop.id,admCatId,name,desc,price,cls,mdl,ord);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   EVENT DELEGATION (Gmod DHTML fix)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
document.addEventListener('click', function(e) {
    var el = e.target;
    for(var i=0;i<8;i++){
        if(!el||el===document.body) break;
        var act = el.getAttribute('data-action');
        var cat = el.getAttribute('data-cat');
        var bid = el.getAttribute('data-buy-id');

        if(cat !== null) {
            if(el.classList.contains('locked')) return;
            selCat = cat === 'all' ? null : parseInt(cat);
            renderCats(); renderGrid();
            return;
        }
        if(bid !== null) {
            e.stopPropagation();
            openBuy(parseInt(bid));
            return;
        }
        if(act) {
            e.stopPropagation();
            handleAction(act, el);
            return;
        }
        el = el.parentElement;
    }
}, true);

document.getElementById('search').addEventListener('input', function() {
    q = this.value;
    renderGrid();
});

document.addEventListener('change', function(e) {
    if(e.target.id === 'a-item-cat') {
        admCatId = parseInt(e.target.value);
        renderAdm();
    }
});

function handleAction(act, el) {
    var shop = AS?AS.shop:(S?S.shop:null);
    var id = el.getAttribute('data-id');
    var editId = el.getAttribute('data-edit');
    if(id) id = parseInt(id);
    if(editId) editId = parseInt(editId);

    switch(act) {
        case 'close-menu': _lua('closeMenu'); break;
        case 'open-admin': openAdm(); break;
        case 'close-admin': closeAdm(); break;
        case 'buy-cancel': closeBuy(); break;
        case 'buy-confirm': doBuy(); break;

        case 'save-general':
            if(!shop) return;
            var nm=document.getElementById('a-name').value.trim();
            var md=document.getElementById('a-model').value;
            if(!nm){toast('Nom requis.',true);return;}
            _lua('updateShop',shop.id,nm,md);
            break;
        case 'delete-shop':
            if(!shop) return;
            _lua('deleteShop',shop.id);
            closeAdm();
            _lua('closeMenu');
            break;

        case 'add-cat-form': showCatForm(null); break;
        case 'cancel-cat-form':
            var z=document.getElementById('cat-form-zone');
            if(z) z.innerHTML='';
            break;
        case 'edit-cat':
            if(!shop) return;
            var cats=shop.categories||[];
            var cat=null;
            for(var i=0;i<cats.length;i++){if(cats[i].id===id){cat=cats[i];break;}}
            if(cat) showCatForm(cat);
            break;
        case 'del-cat':
            if(!shop) return;
            _lua('deleteCategory', shop.id, id);
            break;
        case 'save-cat':
            doSaveCat(editId||null);
            break;
        case 'toggle-sc':
            el.classList.toggle('on');
            break;

        case 'add-item-form': showItemForm(null); break;
        case 'cancel-item-form':
            var z2=document.getElementById('item-form-zone');
            if(z2) z2.innerHTML='';
            break;
        case 'edit-item':
            if(!shop) return;
            var item=findItemInShop(shop,id);
            if(item) showItemForm(item);
            break;
        case 'del-item':
            if(!shop) return;
            _lua('deleteItem', shop.id, id);
            break;
        case 'save-item':
            doSaveItem(editId||null);
            break;
    }
}

document.getElementById('adm-tabs').addEventListener('click', function(e) {
    var t = e.target;
    if(t.classList.contains('adm-tab') && t.getAttribute('data-tab')) {
        setAdmTab(t.getAttribute('data-tab'));
    }
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HELPERS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function fmt(n){return Number(n||0).toLocaleString('fr-FR');}
function esc(s){if(!s)return'';var d=document.createElement('div');d.textContent=s;return d.innerHTML;}
function escA(s){if(!s)return'';return s.replace(/"/g,'&quot;').replace(/'/g,'&#39;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
function isLocked(c,ps){if(!c.allowed_sectors||!c.allowed_sectors.length)return false;if(!ps)return true;return c.allowed_sectors.indexOf(ps)===-1;}
function findItem(id){if(!S||!S.shop)return null;var cats=S.shop.categories||[];for(var i=0;i<cats.length;i++){var items=cats[i].items||[];for(var j=0;j<items.length;j++){if(items[j].id===id)return items[j];}}return null;}
function findItemInShop(shop,id){var cats=shop.categories||[];for(var i=0;i<cats.length;i++){var items=cats[i].items||[];for(var j=0;j<items.length;j++){if(items[j].id===id)return items[j];}}return null;}
function emoji(it){if(!it)return'ğŸ“¦';var c=(it.entity_class||'').toLowerCase();if(c.indexOf('weapon')!==-1||c.indexOf('gun')!==-1||c.indexOf('pistol')!==-1)return'ğŸ”«';if(c.indexOf('knife')!==-1||c.indexOf('sword')!==-1)return'ğŸ—¡ï¸';if(c.indexOf('ammo')!==-1)return'ğŸ¯';if(c.indexOf('armor')!==-1||c.indexOf('kevlar')!==-1||c.indexOf('shield')!==-1)return'ğŸ›¡ï¸';if(c.indexOf('health')!==-1||c.indexOf('medkit')!==-1||c.indexOf('med')!==-1)return'ğŸ’Š';if(c.indexOf('food')!==-1||c.indexOf('drink')!==-1)return'ğŸ”';if(c.indexOf('car')!==-1||c.indexOf('vehicle')!==-1)return'ğŸš—';if(c.indexOf('key')!==-1||c.indexOf('lock')!==-1)return'ğŸ”‘';if(c.indexOf('phone')!==-1||c.indexOf('radio')!==-1)return'ğŸ“±';if(c.indexOf('drug')!==-1||c.indexOf('weed')!==-1||c.indexOf('meth')!==-1)return'ğŸ§ª';if(c.indexOf('money')!==-1||c.indexOf('printer')!==-1)return'ğŸ’°';if(c.indexOf('tool')!==-1)return'ğŸ”§';return'ğŸ“¦';}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   KEYBOARD
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
document.addEventListener('keydown',function(e){
    if(e.key==='Escape'){
        if(document.getElementById('buy-overlay').classList.contains('on')) closeBuy();
        else if(document.getElementById('adm-overlay').classList.contains('on')) closeAdm();
        else _lua('closeMenu');
    }
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DEMO (browser-only fallback)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
setTimeout(function(){
    if(typeof lua==='undefined'){
        window.receiveShopState({
            shop:{id:1,name:'Armurerie Centrale',npc_model:'models/humans/group01/male_07.mdl',
                categories:[
                    {id:1,name:'Pistolets',icon:'ğŸ”«',sort_order:1,allowed_sectors:[],
                        items:[{id:1,name:'Glock 18',description:'Pistolet semi-auto fiable et prÃ©cis.',price:500,entity_class:'weapon_glock',model:'',sort_order:1},{id:2,name:'USP Match',description:'Pistolet avec silencieux intÃ©grÃ©.',price:750,entity_class:'weapon_usp',model:'',sort_order:2},{id:3,name:'Desert Eagle',description:'Puissant pistolet gros calibre.',price:1200,entity_class:'weapon_deagle',model:'',sort_order:3}]},
                    {id:2,name:'Fusils',icon:'ğŸ¯',sort_order:2,allowed_sectors:['SÃ©curitÃ©'],
                        items:[{id:4,name:'AK-47',description:'Fusil d\'assaut automatique emblÃ©matique.',price:3500,entity_class:'weapon_ak47',model:'',sort_order:1},{id:5,name:'M4A1',description:'Fusil d\'assaut avec silencieux.',price:3200,entity_class:'weapon_m4a1',model:'',sort_order:2}]},
                    {id:3,name:'Ã‰quipement',icon:'ğŸ›¡ï¸',sort_order:3,allowed_sectors:[],
                        items:[{id:6,name:'Gilet pare-balles',description:'Protection contre les tirs.',price:1000,entity_class:'item_kevlar',model:'',sort_order:1},{id:7,name:'Kit de soins',description:'Restaure votre santÃ©.',price:200,entity_class:'item_medkit',model:'',sort_order:2}]},
                    {id:4,name:'VÃ©hicules',icon:'ğŸš—',sort_order:4,allowed_sectors:['Transport'],
                        items:[{id:8,name:'Sedan',description:'VÃ©hicule 4 places, rapide.',price:15000,entity_class:'vehicle_sedan',model:'',sort_order:1}]},
                    {id:5,name:'Outils',icon:'ğŸ”§',sort_order:5,allowed_sectors:[],
                        items:[{id:9,name:'Lockpick',description:'Crochetage de serrure.',price:800,entity_class:'weapon_lockpick',model:'',sort_order:1},{id:10,name:'Keypad Cracker',description:'Piratage de keypads.',price:1500,entity_class:'weapon_keypadcracker',model:'',sort_order:2}]}
                ]},
            player:{steamid:'76561198000000000',name:'Demo Player',isAdmin:true,money:25000,company:{name:'Security Corp',sector:'SÃ©curitÃ©'}},
            config:{sectors:['CommerÃ§ant','MÃ©cano','Restaurateur','SÃ©curitÃ©','Transport','MÃ©dical','Artisan','LÃ©gal','Autre'],npcModels:['models/humans/group01/male_07.mdl','models/humans/group01/male_01.mdl']}
        });
    }
},1200);
</script>
</body>
</html>
